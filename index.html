<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>我的笔记系统</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      width: 260px;
      border-right: 1px solid #ccc;
      padding: 10px;
      background: #f8f8f8;
      overflow-y: auto;
    }
    #main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    #toolbar, #richbar {
      margin-bottom: 10px;
    }
    #toolbar button, #richbar button {
      margin-right: 6px;
      margin-bottom: 5px;
    }
    #pages {
      max-width: 850px;
      margin: auto;
    }
    .page {
      width: 794px;
      height: 1123px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
      position: relative;
      background: #fff;
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }
    .text-layer {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      padding: 40px;
      box-sizing: border-box;
      z-index: 1;
      outline: none;
      overflow: auto;
    }
    canvas.draw-layer {
      position: absolute;
      top: 0; left: 0;
      z-index: 10;
      pointer-events: none;
    }
    .folder, .note {
      margin: 4px 0;
      padding: 4px 6px;
      cursor: pointer;
      border-radius: 4px;
    }
    .folder:hover, .note:hover {
      background: #e6f7ff;
    }
    .folder-title {
      font-weight: bold;
      margin-top: 10px;
    }
    .note-actions {
      display: inline-block;
      margin-left: 10px;
    }
    .page.selected {
      box-shadow: 0 0 10px #1890ff;
    }
    .modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 5px;
}

@keyframes thinking {
  0% { content: "思考中"; }
  25% { content: "思考中."; }
  50% { content: "思考中.."; }
  75% { content: "思考中..."; }
}
#ai-response:before {
  content: "思考中";
  animation: thinking 1.5s infinite;
}
    /* AI面板样式优化 */
#ai-panel .modal-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 5px 30px rgba(0,0,0,0.3);
}

#ai-question {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 12px;
  font-size: 16px;
  resize: vertical;
}

#ai-response {
  background: #f9f9f9;
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  min-height: 100px;
  line-height: 1.6;
}

button {
  background: #1890ff;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}

button:hover {
  background: #40a9ff;
}
  
  </style>
</head>


<body>

<div id="sidebar">
  <h3>📁 文件管理</h3>
  <button onclick="createFolder()">📂 新建文件夹</button>
  <ul id="folder-list"></ul>
</div>

<div id="main">
  <h2 id="note-title">未命名笔记</h2>

  <div id="toolbar">
    <button onclick="switchMode('text')">📝 文字模式</button>
    <button onclick="switchMode('draw')">✏️ 绘图模式</button>
    <button onclick="switchMode('select')">🖱 对象模式</button>
    <button onclick="deleteSelected()">🗑 删除选中</button>
    <button onclick="addPage()">➕ 添加页面</button>
    <button onclick="insertImage()">🖼 插图</button>
    <button onclick="cropImage()">✂️ 裁剪图像</button>
    <button onclick="deleteSelectedPage()">🗑 删除当前页</button>
    <button onclick="saveNote()">💾 手动保存</button>
    <button onclick="exportPage()">📷 导出当前页</button>
    <button id="ai-assistant" style="font-size:16px;padding:5px 10px;">
    <span style="font-size:1.2em">🤖</span> AI助手
      <button onclick="saveConversation()" style="margin-top: 15px;">💾 保存对话</button>
    </button>

    <input type="file" id="img-file" accept="image/*" style="display:none">
  </div>

  <div id="draw-controls" style="margin-bottom: 10px;">
  <label>🖌 颜色：<input type="color" id="draw-color" value="#000000"></label>
  <label style="margin-left: 10px;">粗细：<input type="range" id="draw-size" min="1" max="20" value="2"></label>
</div>

  <div id="richbar">
    <button onclick="execCmd('bold')">加粗</button>
    <button onclick="execCmd('italic')">斜体</button>
    <button onclick="execCmd('underline')">下划线</button>
    <button onclick="setTextColor()">文字颜色</button>
<button onclick="setHighlightColor()">高亮</button>
  </div>

  <div id="pages"></div>
</div>

<div id="ai-panel" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:80%; max-width:600px;">
    <h3>AI 助手</h3>
    <textarea id="ai-question" style="width:100%; height:100px; margin:10px 0; padding:8px;" 
              placeholder="输入您的问题..."></textarea>
    <div style="display:flex; gap:10px;">
      <button onclick="askAI()" style="flex:1; padding:8px; background:#1890ff; color:white; border:none; border-radius:4px;">
        提问
      </button>
      <button onclick="closeAIPanel()" style="flex:1; padding:8px; background:#f5222d; color:white; border:none; border-radius:4px;">
        关闭
      </button>
    </div>
    <div id="ai-response" style="margin-top:15px; padding:10px; border:1px solid #eee; border-radius:4px;"></div>
  </div>
</div>

  <!-- 在AI面板中添加快捷按钮 -->
<div class="quick-actions" style="margin: 10px 0; display: flex; gap: 10px;">
  <button onclick="setPrompt('总结当前笔记')">📝 总结</button>
  <button onclick="setPrompt('列出关键点')">🔑 关键点</button>
  <button onclick="setPrompt('优化这段表述')">✨ 优化</button>
  <button onclick="setPrompt('生成思维导图')">🧠 思维导图</button>
</div>


<script>
let folders = JSON.parse(localStorage.getItem('myFolders') || '{}');
let canvases = {};
let pageCount = 0;
let currentFolder = null, currentNote = null, currentMode = 'text';

// 更新存储
function saveToStorage() {
  localStorage.setItem('myFolders', JSON.stringify(folders));
}

// 初始化左侧文件夹
function renderFolders() {
  const list = document.getElementById('folder-list');
  list.innerHTML = '';
  for (let f in folders) {
    const div = document.createElement('div');
    div.className = 'folder';
    div.innerHTML = `<div class="folder-title">${f}</div>`;
    const ul = document.createElement('ul');
    for (let id in folders[f].notes) {
      const li = document.createElement('li');
      li.className = 'note';
      li.innerHTML = `
        <span onclick="loadNote('${f}','${id}')">${folders[f].notes[id].title}</span>
        <span class="note-actions">
          <button onclick="renameNote(event, '${f}', '${id}')">✏</button>
          <button onclick="deleteNote(event, '${f}', '${id}')">🗑</button>
        </span>`;
      ul.appendChild(li);
    }
    const newBtn = document.createElement('button');
    newBtn.textContent = '📝 新建笔记';
    newBtn.onclick = () => createNote(f);
    div.appendChild(newBtn);
    div.appendChild(ul);
    list.appendChild(div);
  }
}

// 设置文字颜色
async function setTextColor() {
  const color = await showColorPicker("选择文字颜色");
  if (color) {
    document.execCommand("foreColor", false, color);
  }
}

// 设置背景高亮颜色
async function setHighlightColor() {
  const color = await showColorPicker("选择背景高亮颜色");
  if (color) {
    document.execCommand("backColor", false, color);
  }
}

// 显示颜色选择器（替代prompt）
function showColorPicker(title) {
  return new Promise((resolve) => {
    // 创建一个颜色选择输入框
    const colorInput = document.createElement("input");
    colorInput.type = "color";
    colorInput.title = title;

    // 当用户选择颜色后
    colorInput.addEventListener("change", () => {
      resolve(colorInput.value); // 返回颜色值
    });

    // 点击取消（关闭颜色选择器）
    colorInput.addEventListener("cancel", () => {
      resolve(null); // 返回null表示取消
    });

    // 触发颜色选择器
    colorInput.click();
  });
}

async function createFolder() {
  const folderName = await showInputDialog("新建文件夹", "请输入文件夹名称");
  if (!folderName) return; // 用户点击取消
  if (folders[folderName]) {
    alert("文件夹已存在！");
    return;
  }
  folders[folderName] = { notes: {} };
  saveToStorage();
  renderFolders();
}

// 新增：显示输入对话框（替代prompt）
function showInputDialog(title, message) {
  return new Promise((resolve) => {
    const dialog = document.createElement("div");
    dialog.style.position = "fixed";
    dialog.style.top = "0";
    dialog.style.left = "0";
    dialog.style.width = "100%";
    dialog.style.height = "100%";
    dialog.style.backgroundColor = "rgba(0,0,0,0.5)";
    dialog.style.display = "flex";
    dialog.style.justifyContent = "center";
    dialog.style.alignItems = "center";
    dialog.style.zIndex = "1000";

    dialog.innerHTML = `
      <div style="background: white; padding: 20px; border-radius: 8px;">
        <h3>${title}</h3>
        <p>${message}</p>
        <input type="text" id="folder-name-input" style="width: 100%; padding: 8px; margin: 10px 0;">
        <div style="text-align: right;">
          <button onclick="confirmInput()">确定</button>
          <button onclick="cancelInput()">取消</button>
        </div>
      </div>
    `;

    document.body.appendChild(dialog);

    window.confirmInput = () => {
      const input = document.getElementById("folder-name-input").value;
      document.body.removeChild(dialog);
      resolve(input);
    };

    window.cancelInput = () => {
      document.body.removeChild(dialog);
      resolve(null);
    };
  });
}

async function createNote(folder) {
  const title = await showInputDialog("新建笔记", "笔记标题：");
  if (!title) return; // 用户点击取消
  const id = 'note_' + Date.now();
  folders[folder].notes[id] = { title, pages: [] };
  saveToStorage();
  loadNote(folder, id);
}

function loadNote(folder, noteId) {
  saveNote(); // 切换时保存上一个
  currentFolder = folder;
  currentNote = noteId;
  const note = folders[folder].notes[noteId];
  document.getElementById('note-title').textContent = note.title;
  const pages = document.getElementById('pages');
  pages.innerHTML = '';
  canvases = {}; pageCount = 0;
  note.pages.forEach((page, index) => {
    const pid = createPage(page.textHTML);
    canvases[pid].loadFromJSON(page.canvasJSON, canvases[pid].renderAll.bind(canvases[pid]));
  });
  if (note.pages.length === 0) addPage(); // 如果是空笔记则加一页
  switchMode(currentMode);
}

function saveNote() {
  if (!currentFolder || !currentNote) return;
  const note = folders[currentFolder].notes[currentNote];
  note.pages = [];
  for (let i = 1; i <= pageCount; i++) {
    note.pages.push({
      textHTML: document.getElementById(`text-${i}`).innerHTML,
      canvasJSON: canvases[i].toJSON()
    });
  }
  saveToStorage();
}

function createPage(initText = '') {
  pageCount++;
  const pages = document.getElementById('pages');
  const page = document.createElement('div');
  page.className = 'page';
page.onclick = () => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('selected'));
    page.classList.add('selected');
  };
  const text = document.createElement('div');
  text.className = 'text-layer';
  text.id = `text-${pageCount}`;
  text.contentEditable = true;
  text.innerHTML = initText || `<p>第 ${pageCount} 页内容...</p >`;
  const canvasEl = document.createElement('canvas');
  canvasEl.className = 'draw-layer';
  canvasEl.id = `canvas-${pageCount}`;
  canvasEl.width = 794;
  canvasEl.height = 1123;
  page.appendChild(text);
  page.appendChild(canvasEl);
  pages.appendChild(page);
  const canvas = new fabric.Canvas(canvasEl.id, { isDrawingMode: false });
  canvas.freeDrawingBrush.width = 2;
  canvas.freeDrawingBrush.color = '#000';
  canvases[pageCount] = canvas;
  return pageCount;
}

function addPage() {
  createPage();
  switchMode(currentMode);
  saveNote();
}

function switchMode(mode) {
  currentMode = mode;
  for (let i = 1; i <= pageCount; i++) {
    const canvas = canvases[i];
    const u = canvas.upperCanvasEl;
    if (mode === 'text') u.style.pointerEvents = 'none';
    else u.style.pointerEvents = 'auto';
    canvas.freeDrawingBrush.color = document.getElementById('draw-color').value;
    canvas.freeDrawingBrush.width = parseInt(document.getElementById('draw-size').value);
    canvas.isDrawingMode = (mode === 'draw');
  }
}

function deleteSelected() {
  for (let i = 1; i <= pageCount; i++) {
    const c = canvases[i];
    if (c.getActiveObjects().length > 0) {
  c.getActiveObjects().forEach(obj => c.remove(obj));
  c.discardActiveObject().renderAll();
}
  }
}

function insertImage() {
  document.getElementById('img-file').click();
}

document.getElementById('img-file').onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const selected = document.querySelector('.page.selected');
  if (!selected) return alert('请先点击选中一个页面');
  const pid = parseInt(selected.querySelector('canvas').id.split('-')[1]);
  const canvas = canvases[pid];

  const reader = new FileReader();
  reader.onload = f => {
    const imgUrl = f.target.result;
    fabric.Image.fromURL(imgUrl, function(img) {
      img.set({
        left: 100,
        top: 100,
        scaleX: 0.4,
        scaleY: 0.4,
        selectable: true
      });
      canvas.add(img);
      canvas.setActiveObject(img);
      canvas.renderAll();
    }, { crossOrigin: 'anonymous' });
  };
  reader.readAsDataURL(file);
};

function cropImage() {
  const selected = document.querySelector('.page.selected');
  if (!selected) return alert('请先选中页面');

  const pid = parseInt(selected.querySelector('canvas').id.split('-')[1]);
  const canvas = canvases[pid];
  const active = canvas.getActiveObject();
  if (!active || active.type !== 'image') {
    return alert('请选中一个图片对象');
  }

  const cropped = new fabric.Image(active.getElement(), {
    left: active.left,
    top: active.top,
    angle: active.angle,
    scaleX: active.scaleX,
    scaleY: active.scaleY,
    cropX: 50, // 从左裁50像素
    cropY: 50, // 从上裁50像素
    width: 200,
    height: 200
  });

  canvas.remove(active);
  canvas.add(cropped).setActiveObject(cropped);
}

function exportPage() {
  const selectedPage = document.querySelector('.page.selected') || document.querySelector('.page:last-child');
  if (!selectedPage) return alert("没有选中的页面！");
  html2canvas(selectedPage).then(canvas => {
    const link = document.createElement('a');
    link.download = 'note_page.png';
    link.href = canvas.toDataURL();
    link.click();
  });
}

function execCmd(cmd, val = null) {
  document.execCommand(cmd, false, val);
}

function renameNote(e, folder, id) {
  e.stopPropagation();
  const newTitle = prompt('新标题：');
  if (!newTitle) return;
  folders[folder].notes[id].title = newTitle;
  saveToStorage();
  renderFolders();
}

function deleteSelectedPage() {
  const selected = document.querySelector('.page.selected');
  if (!selected) return alert("请先点击选中要删除的页面");
  const idx = Array.from(document.querySelectorAll('.page')).indexOf(selected) + 1;
  delete canvases[idx];
  selected.remove();
  pageCount--;
  saveNote();
}

function deleteNote(e, folder, id) {
  e.stopPropagation();
  if (!confirm('确定删除此笔记？')) return;
  delete folders[folder].notes[id];
  saveToStorage();
  renderFolders();
  if (currentNote === id) {
    document.getElementById('pages').innerHTML = '';
    document.getElementById('note-title').textContent = '未命名笔记';
  }
}

// 设置画笔颜色
document.getElementById('draw-color').oninput = e => {
  for (let i = 1; i <= pageCount; i++) {
    canvases[i].freeDrawingBrush.color = e.target.value;
  }
};

// 设置画笔粗细
document.getElementById('draw-size').oninput = e => {
  for (let i = 1; i <= pageCount; i++) {
    canvases[i].freeDrawingBrush.width = parseInt(e.target.value);
  }
};

window.addEventListener('beforeunload', saveNote);
renderFolders();

// 全局变量存储API Key（实际项目建议用更安全的方式）
let DEEPSEEK_API_KEY = "key1"; // 替换为您的真实Key

// 打开/关闭AI面板
document.getElementById('ai-assistant').addEventListener('click', () => {
  document.getElementById('ai-panel').style.display = 'flex';
});

// 单独绑定提问按钮（避免HTML中的onclick）
document.querySelector('#ai-panel button:first-child').addEventListener('click', askAI);
document.querySelector('#ai-panel button:last-child').addEventListener('click', closeAIPanel);

function closeAIPanel() {
  document.getElementById('ai-panel').style.display = 'none';
}


let conversationHistory = [];
// 核心AI提问函数
async function askAI() {
  const question = document.getElementById('ai-question').value;
  const responseDiv = document.getElementById('ai-response');
  
  if (!question.trim()) {
    responseDiv.innerHTML = '<p style="color:red">请输入问题</p>';
    return;
  }

  responseDiv.innerHTML = '<p>思考中...</p>';
    try {
    // 添加到历史
    conversationHistory.push({
      role: "user",
      content: question,
      timestamp: new Date().toLocaleTimeString()
    });
    
    // ...API调用...
      
  try {
    const noteContent = document.querySelector('.text-layer').innerText;

    // 使用模拟数据替代真实API调用（开发阶段）（初步用真实API）
    // ---------- 开始模拟 ----------
const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': '替换为我的Key2' // 替换为您的Key
      },
      body: JSON.stringify({
        model: "mistralai/mistral-7b-instruct", // 免费模型
        messages: [
          {
            role: "system",
            content: "你是一个智能笔记助手，当前笔记内容：" + 
                     noteContent.substring(0, 2000)
          },
          {
            role: "user",
            content: question
          }
        ]
      })
    });

    const data = await response.json();
    
    if (data?.choices?.[0]?.message?.content) {
      // 美化AI响应格式
      const formattedResponse = formatAIResponse(data.choices[0].message.content);
      responseDiv.innerHTML = formattedResponse;
    } else {
      throw new Error('API返回数据格式异常');
    }
  } catch (error) {
    // 错误处理（保持模拟模式作为后备）
    console.error('API调用失败:', error);
    responseDiv.innerHTML = `
      <p style="color:red">服务暂时不可用，已启用模拟模式</p>
      <p>${generateMockResponse(question)}</p>
    `;
  }
}

// 格式化AI响应
function formatAIResponse(text) {
  // 将Markdown转换为简单HTML
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // 加粗
    .replace(/\*(.*?)\*/g, '<em>$1</em>') // 斜体
    .replace(/^- (.*$)/gm, '<li>$1</li>') // 列表
    .replace(/\n/g, '<br>');
}

// 更智能的模拟响应
function generateMockResponse(question) {
  const responses = [
    `根据您的笔记，关于"${question}"的关键点有：<br>
    1. 核心概念A<br>
    2. 重要原理B<br>
    3. 应用示例C`,
    
    `针对"${question}"的建议：<br>
    - 考虑增加图表说明<br>
    - 补充相关案例<br>
    - 精炼重点表述`,
    
    `笔记分析：<br>
    您当前笔记包含3个主要部分：<br>
    <ul>
      <li>理论框架</li>
      <li>实践方法</li>
      <li>问题解决方案</li>
    </ul>`
  ];
  
  return responses[Math.floor(Math.random() * responses.length)];
}
    // ---------- 结束模拟 ----------
    // 保存AI响应
    conversationHistory.push({
      role: "assistant",
      content: data.choices[0].message.content,
      timestamp: new Date().toLocaleTimeString()
    });
    
    // 显示完整对话
    renderConversation();
  } 

    if (mockData?.choices?.[0]?.message?.content) {
      responseDiv.innerHTML = `<p>${mockData.choices[0].message.content.replace(/\n/g, '<br>')}</p>`;
    } else {
      throw new Error('API返回数据格式异常');
    }
  } catch (error) {
    console.error('错误详情:', error);
    responseDiv.innerHTML = `
      <p style="color:red">
        ${error.message}<br>
        <small>当前使用模拟数据模式</small>
      </p>
    `;
  }
}

  function renderConversation() {
  const historyHTML = conversationHistory.map(msg => `
    <div class="message ${msg.role}" style="margin-bottom: 10px;">
      <div style="font-weight: bold; color: ${msg.role === 'user' ? '#1890ff' : '#52c41a'}">
        ${msg.role === 'user' ? '您' : 'AI助手'} 
        <small>(${msg.timestamp})</small>
      </div>
      <div>${formatAIResponse(msg.content)}</div>
    </div>
  `).join('');
  
  document.getElementById('ai-response').innerHTML = historyHTML;
  // 滚动到底部
  document.getElementById('ai-response').scrollTop = document.getElementById('ai-response').scrollHeight;
}

  function saveConversation() {
  if (conversationHistory.length === 0) return;
  
  const content = conversationHistory.map(msg => 
    `[${msg.timestamp}] ${msg.role}: ${msg.content}`
  ).join('\n\n');
  
  // 在当前笔记中插入对话
  const textLayer = document.querySelector('.text-layer');
  textLayer.innerHTML += `<div class="ai-conversation">
    <h3>AI对话记录</h3>
    <pre>${content}</pre>
  </div>`;
  
  alert('对话已保存到笔记中！');
}

// 设置快捷指令
function setPrompt(text) {
  document.getElementById('ai-question').value = text;
  askAI(); // 自动提问
}
  
</script>
</body>
</html>
